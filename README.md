# tfg_ros_simulation
Configuración mínima de pkgs ROS y ROS2 (por defecto está activo el brach ros2) para trabajar desde casa con un robot autónomo en simulación. Diseñado para estudiantes de TFG de la universidad de Málaga, grupo de investigación MAPIR.


# Sobre el Interface ROS2 de CoppeliaSim
### PreRequisites
1. Install Coppelia Simulator (from the official webpage)
2. Open CoppeliaSim from terminal (-h => headless)
    - Check that the ROS2 plugin was loaded (successfully).
    - Plugins are loaded when CoppeliaSim is launched (only on startup). 
    - Make sure to source the ROS2 environment prior to running CoppeliaSim (see .bashrc).
    - The plugin is now ready to be used.
    
### ERROR loading Plugin: Manual Compilation Needed (only once)
If the plugin cannot be loaded, then you should recompile it by yourself. It is open source. Once compiled, copy the generated .so file to the Coppelia root directory.
- The pluggin is generated by compiling the /sim_ros2_interface pkg
- By default this package contains a COLCON_IGNORE as it only has to be compiled once.
- Remove the "COLCON_IGNORE" file
- Edit `meta/interfaces.txt` if you need to include more ROS interfaces. This pkg already contains laser abd Twist, but others can be added (see instructions below).
- Install xsltproc:
    sudo apt install xsltproc 
- Compile with:
    export COPPELIASIM_ROOT_DIR=~/path/to/coppeliaSim/folder
    ulimit -s unlimited #otherwise compilation might freeze/crash
    colcon build --packages-select sim_ros2_interface --symlink-install --cmake-args -DCMAKE_BUILD_TYPE=Release
- Add the "COLCON_IGNORE" file to avoid further compilations
- Copy the library to Coppelia root directory
    ros_ws/build/sim_ros2_interface/libsimExtROS2.so --> CopeliaRoot Directory
- check that the plugin is loaded when CoppeliaSim starts

### ERROR compiling the interface
- The interface pkg requires huge amomunts of RAM memory to be compiled. In VM this can lead to errors like: c++: fatal error: Killed signal terminated program cc1plus
- To solve this, ensure the VM is provided with a enough memory (at least 8Gb in total, between RAM and SWAP, are necessary
- If you cannot locate more RAM for the VM, here there are instructions to enlarge the SWAP partition. Concretely this example creates a 4Gb SWAP partition
  1. sudo dd if=/dev/zero of=/swapfile2 bs=1024 count=4194304
  2. sudo chmod 600 /swapfile2
  3. sudo mkswap /swapfile2
  4. sudo swapon /swapfile2
  
  Complete instructions here: https://linuxize.com/post/how-to-add-swap-space-on-ubuntu-20-04/
  
### ToDo
- Ensure Coppelia publish the correct TFs and topics.
- Ensure nav2 nodes publish in the correct youbot/cmd_vel topic or apply remaps.  
- check nav2_recoveries for Humble (not yet available)
